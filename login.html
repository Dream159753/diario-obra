<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login • Diário de Obra</title>
  <style>
    :root{
      --bg:#f4f6fb; --card:#ffffff; --prim:#3A6385; --prim-dark:#284666;
      --muted:#7b8794; --border:#e2e8f0; --danger:#e53e3e;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Arial,Helvetica,sans-serif; background:var(--bg); color:#102a43;
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:18px;
    }
    .wrap{width:100%; max-width:420px}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px;
      box-shadow:0 10px 26px rgba(15,23,42,.08); padding:18px 18px 16px;
    }
    h1{margin:0 0 6px; font-size:20px}
    p{margin:0 0 14px; color:var(--muted); font-size:13px; line-height:1.35}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      font-size:14px; outline:none; background:#fff;
    }
    input:focus{border-color:var(--prim); box-shadow:0 0 0 3px rgba(58,99,133,.12)}
    .row{display:flex; gap:10px; margin-top:14px; align-items:center}
    button{
      width:100%; padding:10px 14px; border-radius:12px; border:none; cursor:pointer;
      background:var(--prim); color:#fff; font-weight:700; font-size:14px;
    }
    button:hover{background:var(--prim-dark)}
    .hint{
      margin-top:12px; font-size:12px; color:var(--muted); text-align:center;
    }
    .error{
      display:none; margin-top:12px; padding:10px 12px; border-radius:12px;
      background:#fff5f5; border:1px solid #fed7d7; color:var(--danger); font-size:13px;
    }
    .small{
      margin-top:10px; font-size:12px; color:var(--muted); text-align:center;
    }
    .tag{
      display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--border);
      background:#f8fafc; color:#233; font-size:12px; margin-top:8px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Entrar</h1>
      <p>Faça login para acessar o sistema do <strong>Diário de Obra</strong>.</p>

      <form id="loginForm" autocomplete="off">
        <label for="email">E-mail</label>
        <input id="email" name="email" type="email" placeholder="ex: apontador@obra.local" required />

        <label for="senha">Senha</label>
        <input id="senha" name="senha" type="password" placeholder="••••••••" required />

        <div class="row">
          <button id="btnEntrar" type="submit">Entrar</button>
        </div>

        <div id="errorBox" class="error"></div>

        <div class="hint">
          <span class="tag">Dica: após logar, você será levado para a página inicial.</span>
        </div>
        <div class="small">
          (Se você tentou abrir uma página específica, voltaremos automaticamente para ela.)
        </div>
      </form>
    </div>
  </div>

<script>
  const form = document.getElementById('loginForm');
  const errorBox = document.getElementById('errorBox');
  const btn = document.getElementById('btnEntrar');

  function showError(msg){
    errorBox.textContent = msg || 'Falha no login.';
    errorBox.style.display = 'block';
  }
  function hideError(){
    errorBox.style.display = 'none';
    errorBox.textContent = '';
  }

  function isCuradoriaPath(p){
    if(!p) return false;
    // protege tudo que é curadoria/revisão
    return (
      p.startsWith('/viewer') ||
      p.startsWith('/details') ||
      p.startsWith('/edit') ||
      p.startsWith('/admin') ||
      p.startsWith('/api/diarios') // em geral apontador não deveria navegar nisso
    );
  }

  async function getMe(){
    try{
      const r = await fetch('/api/me', { credentials:'include' });
      const j = await r.json();
      return j.user || null;
    } catch {
      return null;
    }
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideError();

    const email = (document.getElementById('email').value || '').trim();
    const senha = (document.getElementById('senha').value || '').trim();
    if(!email || !senha){
      showError('Informe e-mail e senha.');
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Entrando...';

    try{
      const r = await fetch('/api/login', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        credentials:'include',
        body: JSON.stringify({ email, senha })
      });

      const j = await r.json().catch(()=> ({}));
      if(!r.ok){
        showError(j.error || 'Usuário ou senha inválidos.');
        return;
      }

      // ✅ Redirect pós-login:
      // - Se tiver next, respeita
      // - Se for apontador e next for curadoria, força "/"
      // - Default sempre "/"
      const params = new URLSearchParams(location.search);
      let next = params.get('next') || '/';

      const user = await getMe();
      if(user && user.role === 'apontador' && isCuradoriaPath(next)){
        next = '/';
      }

      location.href = next;

    } catch(err){
      console.error(err);
      showError('Não foi possível conectar ao servidor.');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Entrar';
    }
  });

  // opcional: se já estiver logado, manda pra home
  window.addEventListener('DOMContentLoaded', async ()=>{
    const user = await getMe();
    if(user) location.href = '/';
  });
</script>
</body>
</html>
