<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Administração</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#f4f6fb; --card:#ffffff; --prim:#3A6385; --prim-dark:#284666;
      --muted:#7b8794; --border:#e2e8f0; --danger:#e53e3e; --ok:#1b8a5a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#1f2933}
    header{background:#fff;border-bottom:1px solid var(--border);padding:16px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10}
    header h1{margin:0;font-size:20px;font-weight:600;color:#102a43}
    header small{display:block;font-size:12px;color:var(--muted)}
    .user-area{display:flex;align-items:center;gap:12px;font-size:14px;color:var(--muted)}
    .btn{padding:8px 14px;border-radius:6px;border:none;cursor:pointer;font-size:14px;background:var(--prim);color:#fff}
    .btn:hover{background:var(--prim-dark)}
    .btn-outline{background:#fff;color:var(--prim);border:1px solid var(--prim)}
    .btn-outline:hover{background:var(--prim);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-danger:hover{filter:brightness(.95)}
    main{max-width:1100px;margin:24px auto 40px;padding:0 16px}
    .card{background:var(--card);border-radius:10px;box-shadow:0 8px 24px rgba(15,23,42,.06);padding:16px 18px 20px;margin-bottom:18px}
    h2{margin:0 0 10px;font-size:16px;color:#102a43}
    p{margin:0 0 12px;color:var(--muted);font-size:13px}
    label{font-size:12px;color:var(--muted);margin-bottom:2px;display:block}
    input,select{width:100%;padding:7px 8px;border-radius:6px;border:1px solid var(--border);font-size:13px;outline:none}
    input:focus,select:focus{border-color:var(--prim);box-shadow:0 0 0 2px rgba(58,99,133,.16)}
    .grid3{display:grid;grid-template-columns: 1.4fr 1fr 1fr; gap:10px; align-items:end}
    table{width:100%;border-collapse:collapse;font-size:14px}
    thead th{background:var(--prim);color:#fff;padding:10px 8px;text-align:left}
    tbody td{border-bottom:1px solid var(--border);padding:8px 8px}
    tbody tr:nth-child(even){background:#f8fafc}
    .row-actions{display:flex;gap:8px;flex-wrap:wrap}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#f8fafc;color:#334}
    .pill.ok{border-color:#cdeedd;background:#eaf7f0;color:var(--ok)}
    .pill.off{border-color:#f7c6c1;background:#fdecea;color:var(--danger)}
    .error{margin-top:10px;font-size:13px;color:var(--danger);display:none;white-space:pre-line}
    @media (max-width:900px){.grid3{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <div>
    <h1>Administração</h1>
    <small>Usuários e Obras do sistema</small>
  </div>
  <div class="user-area">
    <span id="userGreeting">Olá, …</span>
    <button id="btnLogout" class="btn btn-outline">Sair</button>
  </div>
</header>

<main>

  <!-- NOVO USUÁRIO -->
  <section class="card">
    <h2>Novo usuário</h2>
    <p>Crie um usuário para acessar o sistema. Perfis: admin, engenheiro ou apontador.</p>

    <div class="grid3">
      <div>
        <label for="uEmail">E-mail (login)</label>
        <input id="uEmail" type="email" placeholder="ex: fulano@obra.local">
      </div>
      <div>
        <label for="uSenha">Senha</label>
        <input id="uSenha" type="text" placeholder="Senha inicial">
      </div>
      <div>
        <label for="uRole">Perfil</label>
        <select id="uRole">
          <option value="apontador">apontador</option>
          <option value="engenheiro">engenheiro</option>
          <option value="admin">admin</option>
        </select>
      </div>
    </div>

    <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
      <button class="btn" id="btnCriarUser">Criar usuário</button>
    </div>

    <div id="errUser" class="error"></div>
  </section>

  <!-- USUÁRIOS CADASTRADOS -->
  <section class="card">
    <h2>Usuários cadastrados</h2>
    <p>Acesso restrito a administradores.</p>

    <table>
      <thead>
        <tr>
          <th style="width:70px;">ID</th>
          <th>E-mail</th>
          <th style="width:140px;">Perfil</th>
          <th style="width:100px;">Ativo</th>
          <th style="width:170px;">Criado em</th>
          <th style="width:180px;">Nova Senha</th>
          <th style="width:210px;">Ações</th>
        </tr>
      </thead>
      <tbody id="tbUsers"></tbody>
    </table>

    <div id="emptyUsers" style="display:none; color:var(--muted); padding:10px 0;">Nenhum usuário encontrado.</div>
  </section>

  <!-- ✅ NOVA OBRA -->
  <section class="card">
    <h2>Nova obra</h2>
    <p>Cadastre obras para aparecerem no formulário (apontador só seleciona).</p>

    <div class="grid3">
      <div style="grid-column:1 / span 2;">
        <label for="oNome">Nome da obra</label>
        <input id="oNome" type="text" placeholder="Ex: Obra Vila Mariana - Torre A">
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn" id="btnCriarObra" style="width:100%;">Cadastrar obra</button>
      </div>
    </div>

    <div id="errObra" class="error"></div>
  </section>

  <!-- ✅ OBRAS CADASTRADAS -->
  <section class="card">
    <h2>Obras cadastradas</h2>
    <p>Edite nome, ative/desative ou exclua obras.</p>

    <table>
      <thead>
        <tr>
          <th style="width:70px;">ID</th>
          <th>Obra</th>
          <th style="width:120px;">Status</th>
          <th style="width:170px;">Criado em</th>
          <th style="width:280px;">Ações</th>
        </tr>
      </thead>
      <tbody id="tbObras"></tbody>
    </table>

    <div id="emptyObras" style="display:none; color:var(--muted); padding:10px 0;">Nenhuma obra cadastrada.</div>
  </section>

</main>

<script>
  async function carregarUsuario(){
    const r = await fetch('/api/me', { credentials:'include' });
    const { user } = await r.json();
    if(!user) { location.href='login.html'; return; }
    document.getElementById('userGreeting').textContent = `Olá, ${(user.email||'').split('@')[0] || 'usuário'}`;
  }

  async function logout(){
    try{ await fetch('/api/logout', { method:'POST', credentials:'include' }); }
    finally{ location.href='login.html'; }
  }
  document.getElementById('btnLogout').addEventListener('click', logout);

  function showErr(id, msg){
    const el = document.getElementById(id);
    el.textContent = msg || '';
    el.style.display = msg ? 'block' : 'none';
  }

  // ---------- USERS ----------
  async function loadUsers(){
    const tb = document.getElementById('tbUsers');
    tb.innerHTML='';
    showErr('errUser','');

    const r = await fetch('/api/users', { credentials:'include' });
    if(r.status===401) { location.href='login.html'; return; }
    if(r.status===403) { location.href='index.html'; return; }
    const rows = await r.json();

    if(!rows.length){
      document.getElementById('emptyUsers').style.display='block';
      return;
    }
    document.getElementById('emptyUsers').style.display='none';

    rows.forEach(u=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.id}</td>
        <td>${u.email}</td>
        <td>
          <select data-role="${u.id}">
            <option value="apontador" ${u.role==='apontador'?'selected':''}>apontador</option>
            <option value="engenheiro" ${u.role==='engenheiro'?'selected':''}>engenheiro</option>
            <option value="admin" ${u.role==='admin'?'selected':''}>admin</option>
          </select>
        </td>
        <td>
          <input type="checkbox" data-active="${u.id}" ${u.active? 'checked':''} />
        </td>
        <td>${u.created_at || ''}</td>
        <td><input type="text" placeholder="Nova senha" data-pass="${u.id}" /></td>
        <td>
          <div class="row-actions">
            <button class="btn btn-outline" data-save-user="${u.id}">Salvar</button>
            <button class="btn btn-danger" data-del-user="${u.id}">Excluir</button>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    });

    tb.querySelectorAll('[data-save-user]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-save-user');
        const role = tb.querySelector(`[data-role="${id}"]`).value;
        const active = tb.querySelector(`[data-active="${id}"]`).checked;
        const senha = tb.querySelector(`[data-pass="${id}"]`).value.trim();

        const payload = { role, active };
        if(senha) payload.senha = senha;

        const r = await fetch(`/api/users/${id}`, {
          method:'PATCH',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if(!r.ok) return alert(j.error || 'Falha ao salvar.');
        alert('Usuário atualizado.');
        loadUsers();
      });
    });

    tb.querySelectorAll('[data-del-user]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-del-user');
        if(!confirm('Excluir este usuário?')) return;
        const r = await fetch(`/api/users/${id}`, { method:'DELETE', credentials:'include' });
        const j = await r.json();
        if(!r.ok) return alert(j.error || 'Falha ao excluir.');
        loadUsers();
      });
    });
  }

  document.getElementById('btnCriarUser').addEventListener('click', async ()=>{
    showErr('errUser','');
    const email = document.getElementById('uEmail').value.trim();
    const senha = document.getElementById('uSenha').value.trim();
    const role  = document.getElementById('uRole').value;

    if(!email || !senha || !role){
      showErr('errUser','Preencha e-mail, senha e perfil.');
      return;
    }

    const r = await fetch('/api/users', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify({ email, senha, role })
    });
    const j = await r.json();
    if(!r.ok){
      showErr('errUser', j.error || 'Não foi possível criar o usuário.');
      return;
    }
    document.getElementById('uEmail').value='';
    document.getElementById('uSenha').value='';
    alert('Usuário criado.');
    loadUsers();
  });

  // ---------- OBRAS ----------
  async function loadObras(){
    const tb = document.getElementById('tbObras');
    tb.innerHTML='';
    showErr('errObra','');

    const r = await fetch('/api/obras/all', { credentials:'include' });
    if(r.status===401) { location.href='login.html'; return; }
    if(r.status===403) { location.href='index.html'; return; }
    const rows = await r.json();

    if(!rows.length){
      document.getElementById('emptyObras').style.display='block';
      return;
    }
    document.getElementById('emptyObras').style.display='none';

    rows.forEach(o=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${o.id}</td>
        <td>
          <input type="text" data-obra-nome="${o.id}" value="${(o.nome||'').replace(/"/g,'&quot;')}" />
        </td>
        <td>
          <span class="pill ${o.active? 'ok':'off'}">${o.active? 'ATIVA':'INATIVA'}</span>
        </td>
        <td>${o.created_at || ''}</td>
        <td>
          <div class="row-actions">
            <button class="btn btn-outline" data-obra-save="${o.id}">Salvar</button>
            <button class="btn btn-outline" data-obra-toggle="${o.id}" data-active="${o.active?1:0}">
              ${o.active? 'Desativar':'Ativar'}
            </button>
            <button class="btn btn-danger" data-obra-del="${o.id}">Excluir</button>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    });

    tb.querySelectorAll('[data-obra-save]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-obra-save');
        const nome = tb.querySelector(`[data-obra-nome="${id}"]`).value.trim();
        if(!nome) return alert('Nome inválido.');

        const r = await fetch(`/api/obras/${id}`, {
          method:'PATCH',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ nome })
        });
        const j = await r.json();
        if(!r.ok) return alert(j.error || 'Falha ao salvar obra.');
        loadObras();
      });
    });

    tb.querySelectorAll('[data-obra-toggle]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-obra-toggle');
        const isActive = btn.getAttribute('data-active') === '1';

        const r = await fetch(`/api/obras/${id}`, {
          method:'PATCH',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ active: !isActive })
        });
        const j = await r.json();
        if(!r.ok) return alert(j.error || 'Falha ao atualizar status.');
        loadObras();
      });
    });

    tb.querySelectorAll('[data-obra-del]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-obra-del');
        if(!confirm('Excluir esta obra? (Ela some do select do form)')) return;

        const r = await fetch(`/api/obras/${id}`, { method:'DELETE', credentials:'include' });
        const j = await r.json();
        if(!r.ok) return alert(j.error || 'Falha ao excluir.');
        loadObras();
      });
    });
  }

  document.getElementById('btnCriarObra').addEventListener('click', async ()=>{
    showErr('errObra','');
    const nome = document.getElementById('oNome').value.trim();
    if(!nome){
      showErr('errObra','Informe o nome da obra.');
      return;
    }
    const r = await fetch('/api/obras', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify({ nome })
    });
    const j = await r.json();
    if(!r.ok){
      showErr('errObra', j.error || 'Falha ao cadastrar obra.');
      return;
    }
    document.getElementById('oNome').value='';
    alert('Obra cadastrada.');
    loadObras();
  });

  window.addEventListener('DOMContentLoaded', async ()=>{
    await carregarUsuario();
    await loadUsers();
    await loadObras();
  });
</script>
</body>
</html>
