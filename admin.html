<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin • Diário de Obra</title>
  <style>
    :root{
      --bg:#f4f6fb; --card:#ffffff; --prim:#3A6385; --prim-dark:#284666;
      --muted:#7b8794; --border:#e2e8f0; --danger:#e53e3e; --ok:#1b8a5a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#102a43}
    header{
      background:#fff;border-bottom:1px solid var(--border);
      padding:16px 24px;display:flex;align-items:center;justify-content:space-between;
      position:sticky;top:0;z-index:10
    }
    header h1{margin:0;font-size:18px;font-weight:800}
    header small{display:block;font-size:12px;color:var(--muted);margin-top:2px}
    .user-area{display:flex;align-items:center;gap:10px;color:var(--muted);font-size:14px}
    .btn{
      padding:8px 14px;border-radius:8px;border:none;cursor:pointer;
      font-size:14px;background:var(--prim);color:#fff
    }
    .btn:hover{background:var(--prim-dark)}
    .btn-outline{background:#fff;color:var(--prim);border:1px solid var(--prim)}
    .btn-outline:hover{background:var(--prim);color:#fff}
    .btn-danger{background:var(--danger)}
    .btn-danger:hover{filter:brightness(.95)}
    .btn-sm{padding:6px 10px;font-size:12px;border-radius:7px}
    .btn-ghost{background:#eef2f6;color:#233}
    .btn-ghost:hover{filter:brightness(.98)}
    .btn-disabled{opacity:.55;pointer-events:none}

    main{max-width:1100px;margin:24px auto 40px;padding:0 16px}
    .card{
      background:var(--card);border-radius:12px;border:1px solid var(--border);
      box-shadow:0 8px 24px rgba(15,23,42,.06);padding:16px 18px 18px;margin-bottom:18px
    }
    h2{margin:0 0 10px;font-size:16px}
    p{margin:6px 0 14px;color:var(--muted);font-size:13px}

    .grid{display:grid;grid-template-columns:2fr 1fr 1fr;gap:10px;align-items:end}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    label{font-size:12px;color:var(--muted);margin-bottom:4px;display:block}
    input,select{
      width:100%;padding:9px 10px;border-radius:8px;border:1px solid var(--border);
      font-size:14px;outline:none;background:#fff
    }
    input:focus,select:focus{border-color:var(--prim);box-shadow:0 0 0 3px rgba(58,99,133,.12)}
    input[disabled], select[disabled]{background:#f8fafc;color:#66758a}
    .row-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}

    table{width:100%;border-collapse:collapse;font-size:14px}
    thead th{background:var(--prim);color:#fff;padding:10px 8px;text-align:left}
    tbody td{border-bottom:1px solid var(--border);padding:8px 8px;vertical-align:middle}
    tbody tr:nth-child(even){background:#f8fafc}

    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;
      border:1px solid var(--border);font-size:12px;background:#f8fafc;color:#233
    }
    .msg{
      display:none;margin-top:12px;padding:10px 12px;border-radius:10px;border:1px solid var(--border);
      font-size:13px;background:#fff
    }
    .msg.ok{border-color:#cdeedd;background:#eaf7f0;color:#0f5132}
    .msg.err{border-color:#fed7d7;background:#fff5f5;color:#8a1f1f}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;font-size:12px}
    .actions-cell{display:flex;gap:6px;flex-wrap:wrap}
    .w80{width:80px}
    .w120{width:120px}
    .w140{width:140px}
  </style>
</head>
<body>
<header>
  <div>
    <h1>Administração</h1>
    <small>Gerencie usuários e permissões</small>
  </div>
  <div class="user-area">
    <span id="userGreeting">Olá, …</span>
    <a class="btn btn-outline" href="/">Início</a>
    <button id="btnLogout" class="btn btn-outline">Sair</button>
  </div>
</header>

<main>
  <section class="card">
    <h2>Novo usuário</h2>
    <p>Perfis: <span class="pill">admin</span> <span class="pill">engenheiro</span> <span class="pill">curadoria</span> <span class="pill">apontador</span></p>

    <div class="grid">
      <div>
        <label for="newEmail">E-mail (login)</label>
        <input id="newEmail" type="email" placeholder="ex: fulano@obra.local" />
      </div>
      <div>
        <label for="newPass">Senha</label>
        <input id="newPass" type="text" placeholder="Senha inicial" />
      </div>
      <div>
        <label for="newRole">Perfil</label>
        <select id="newRole">
          <option value="apontador">apontador</option>
          <option value="curadoria">curadoria</option>
          <option value="engenheiro">engenheiro</option>
          <option value="admin">admin</option>
        </select>
      </div>
    </div>

    <div class="row-actions">
      <button id="btnCreate" class="btn">Criar usuário</button>
    </div>

    <div id="msgCreate" class="msg"></div>
  </section>

  <section class="card">
    <h2>Usuários cadastrados</h2>
    <p>Acesso restrito a administradores.</p>

    <div id="msgList" class="msg"></div>

    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th class="w80">ID</th>
            <th>E-mail</th>
            <th class="w140">Perfil</th>
            <th class="w120">Ativo</th>
            <th class="w140">Criado em</th>
            <th class="w140">Nova Senha</th>
            <th class="w140">Ações</th>
          </tr>
        </thead>
        <tbody id="tbodyUsers"></tbody>
      </table>
    </div>
  </section>
</main>

<script>
  const $ = (id)=>document.getElementById(id);

  let CURRENT_USER = null;

  function showMsg(el, type, text){
    el.className = 'msg ' + (type === 'ok' ? 'ok' : 'err');
    el.textContent = text;
    el.style.display = 'block';
  }
  function clearMsg(el){
    el.style.display = 'none';
    el.textContent = '';
    el.className = 'msg';
  }

  async function ensureAdmin(){
    const r = await fetch('/api/me', { credentials:'include' });
    const j = await r.json();
    const user = j.user || null;
    if(!user){ location.href='/login.html?next=/admin.html'; return null; }
    if(user.role !== 'admin'){ alert('Acesso restrito a administradores.'); location.href='/'; return null; }
    CURRENT_USER = user;
    $('userGreeting').textContent = `Olá, ${(user.email||'').split('@')[0] || 'admin'}`;
    return user;
  }

  async function logout(){
    try{ await fetch('/api/logout',{ method:'POST', credentials:'include' }); }
    finally{ location.href='/login.html'; }
  }

  function roleSelectHtml(selected){
    const roles = ['apontador','curadoria','engenheiro','admin'];
    return roles.map(r=>`<option value="${r}" ${r===selected?'selected':''}>${r}</option>`).join('');
  }

  function setRowEditing(tr, editing){
    tr.dataset.editing = editing ? '1' : '0';
    const roleEl = tr.querySelector('select[data-role]');
    const actEl  = tr.querySelector('select[data-active]');
    const passEl = tr.querySelector('input[data-pass]');

    roleEl.disabled = !editing;
    actEl.disabled  = !editing;
    passEl.disabled = !editing;

    const btnEdit = tr.querySelector('button[data-edit]');
    const btnSave = tr.querySelector('button[data-save]');
    const btnCancel = tr.querySelector('button[data-cancel]');

    btnEdit.style.display = editing ? 'none' : 'inline-block';
    btnSave.style.display = editing ? 'inline-block' : 'none';
    btnCancel.style.display = editing ? 'inline-block' : 'none';
  }

  function snapshotRow(tr){
    tr.dataset.snapRole = tr.querySelector('select[data-role]').value;
    tr.dataset.snapActive = tr.querySelector('select[data-active]').value;
    tr.dataset.snapPass = '';
    tr.querySelector('input[data-pass]').value = '';
  }

  function restoreRow(tr){
    tr.querySelector('select[data-role]').value = tr.dataset.snapRole || 'apontador';
    tr.querySelector('select[data-active]').value = tr.dataset.snapActive || '1';
    tr.querySelector('input[data-pass]').value = '';
  }

  async function loadUsers(){
    const tbody = $('tbodyUsers');
    const msg = $('msgList');
    clearMsg(msg);
    tbody.innerHTML = '';

    try{
      const r = await fetch('/api/users', { credentials:'include' });
      const data = await r.json().catch(()=>null);

      if(!r.ok){
        showMsg(msg, 'err', (data && data.error) ? data.error : 'Falha ao carregar usuários.');
        return;
      }

      (data || []).forEach(u=>{
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td>${u.id}</td>
          <td>${u.email}</td>
          <td><select data-role="${u.id}" disabled>${roleSelectHtml(u.role)}</select></td>
          <td>
            <select data-active="${u.id}" disabled>
              <option value="1" ${u.active ? 'selected':''}>Sim</option>
              <option value="0" ${!u.active ? 'selected':''}>Não</option>
            </select>
          </td>
          <td class="mono">${u.created_at || ''}</td>
          <td><input data-pass="${u.id}" type="text" placeholder="(opcional)" disabled /></td>
          <td class="actions-cell">
            <button class="btn btn-sm btn-ghost" data-edit="${u.id}">Editar</button>
            <button class="btn btn-sm" data-save="${u.id}" style="display:none;">Salvar</button>
            <button class="btn btn-sm btn-ghost" data-cancel="${u.id}" style="display:none;">Cancelar</button>
            <button class="btn btn-sm btn-danger" data-del="${u.id}">Excluir</button>
          </td>
        `;

        // bloqueia exclusão do próprio admin na UI (server também bloqueia)
        if (CURRENT_USER && Number(u.id) === Number(CURRENT_USER.id)) {
          const delBtn = tr.querySelector('button[data-del]');
          delBtn.classList.add('btn-disabled');
          delBtn.title = 'Você não pode excluir seu próprio usuário.';
        }

        tbody.appendChild(tr);

        // estado inicial
        setRowEditing(tr, false);

        // handlers
        tr.querySelector('button[data-edit]').addEventListener('click', ()=>{
          snapshotRow(tr);
          setRowEditing(tr, true);
        });

        tr.querySelector('button[data-cancel]').addEventListener('click', ()=>{
          restoreRow(tr);
          setRowEditing(tr, false);
        });

        tr.querySelector('button[data-save]').addEventListener('click', ()=>{
          saveUser(u.id, tr);
        });

        tr.querySelector('button[data-del]').addEventListener('click', ()=>{
          deleteUser(u.id, u.email);
        });
      });

    }catch(e){
      console.error(e);
      showMsg(msg, 'err', 'Erro ao carregar usuários.');
    }
  }

  async function createUser(){
    const email = ($('newEmail').value || '').trim();
    const senha = ($('newPass').value || '').trim();
    const role  = $('newRole').value;

    const msg = $('msgCreate');
    clearMsg(msg);

    if(!email || !senha || !role){
      showMsg(msg, 'err', 'Preencha e-mail, senha e perfil.');
      return;
    }

    try{
      const r = await fetch('/api/users', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body: JSON.stringify({ email, senha, role })
      });
      const data = await r.json().catch(()=> ({}));

      if(!r.ok){
        showMsg(msg, 'err', data.error || 'Não foi possível criar o usuário.');
        return;
      }

      showMsg(msg, 'ok', 'Usuário criado com sucesso!');
      $('newEmail').value = '';
      $('newPass').value = '';
      $('newRole').value = 'apontador';

      await loadUsers();

    }catch(e){
      console.error(e);
      showMsg(msg, 'err', 'Erro de conexão ao criar usuário.');
    }
  }

  async function saveUser(id, tr){
    const msg = $('msgList');
    clearMsg(msg);

    const roleEl = tr.querySelector(`select[data-role="${id}"]`);
    const actEl  = tr.querySelector(`select[data-active="${id}"]`);
    const passEl = tr.querySelector(`input[data-pass="${id}"]`);

    const role = roleEl ? roleEl.value : null;
    const active = actEl ? (actEl.value === '1') : null;
    const senha = passEl ? (passEl.value || '').trim() : '';

    const payload = {};
    if(role) payload.role = role;
    if(active !== null) payload.active = active;
    if(senha) payload.senha = senha;

    try{
      const r = await fetch(`/api/users/${id}`, {
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body: JSON.stringify(payload)
      });
      const data = await r.json().catch(()=> ({}));

      if(!r.ok){
        showMsg(msg, 'err', data.error || 'Falha ao atualizar usuário.');
        return;
      }

      showMsg(msg, 'ok', 'Usuário atualizado.');
      setRowEditing(tr, false);
      await loadUsers();

    }catch(e){
      console.error(e);
      showMsg(msg, 'err', 'Erro de conexão ao atualizar usuário.');
    }
  }

  async function deleteUser(id, email){
    const msg = $('msgList');
    clearMsg(msg);

    if (CURRENT_USER && Number(id) === Number(CURRENT_USER.id)) {
      showMsg(msg, 'err', 'Você não pode excluir seu próprio usuário.');
      return;
    }

    const ok = confirm(`Excluir o usuário:\n\n${email}\n\nEssa ação não pode ser desfeita.`);
    if(!ok) return;

    try{
      const r = await fetch(`/api/users/${id}`, {
        method:'DELETE',
        credentials:'include'
      });
      const data = await r.json().catch(()=> ({}));

      if(!r.ok){
        showMsg(msg, 'err', data.error || 'Falha ao excluir usuário.');
        return;
      }

      showMsg(msg, 'ok', 'Usuário excluído.');
      await loadUsers();

    }catch(e){
      console.error(e);
      showMsg(msg, 'err', 'Erro de conexão ao excluir usuário.');
    }
  }

  window.addEventListener('DOMContentLoaded', async ()=>{
    const ok = await ensureAdmin();
    if(!ok) return;

    $('btnLogout').addEventListener('click', logout);
    $('btnCreate').addEventListener('click', createUser);

    await loadUsers();
  });
</script>
</body>
</html>
