<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Curadoria do Diário de Obra</title>
  <style>
    :root {
      --prim:#355b82;
      --prim-dark:#27435f;
      --bg:#f5f7fb;
      --line:#e2e6f0;
      --text:#1f2933;
      --muted:#6b7280;
      --danger:#c0392b;
      --success:#1b8a5a;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px 32px;
      background:#fff;
      box-shadow:0 2px 8px rgba(15,23,42,.06);
      position:sticky;
      top:0;
      z-index:10;
    }
    header h1{
      margin:0;
      font-size:20px;
      font-weight:600;
    }
    header p{
      margin:2px 0 0;
      font-size:13px;
      color:var(--muted);
    }
    .user-box{
      display:flex;
      align-items:center;
      gap:12px;
      font-size:14px;
    }
    .user-box span{
      color:var(--muted);
    }
    .btn{
      border:0;
      border-radius:999px;
      padding:8px 16px;
      font-size:14px;
      cursor:pointer;
      background:var(--prim);
      color:#fff;
    }
    .btn:hover{ background:var(--prim-dark); }
    main{
      max-width:1180px;
      margin:24px auto 40px;
      padding:0 16px 40px;
    }
    .filters{
      background:#fff;
      border-radius:12px;
      box-shadow:0 8px 24px rgba(15,23,42,.06);
      padding:16px 16px 20px;
      margin-bottom:20px;
    }
    .filters-grid{
      display:grid;
      grid-template-columns:repeat(6,minmax(0,1fr));
      gap:10px;
    }
    .filters label{
      font-size:12px;
      color:var(--muted);
      display:block;
      margin-bottom:3px;
    }
    .filters input,
    .filters select{
      width:100%;
      padding:7px 8px;
      border-radius:8px;
      border:1px solid var(--line);
      font-size:13px;
      outline:none;
      background:#f9fafb;
    }
    .filters input:focus,
    .filters select:focus{
      border-color:var(--prim);
      box-shadow:0 0 0 2px rgba(53,91,130,.18);
      background:#fff;
    }
    .filters-actions{
      margin-top:12px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .btn-secondary{
      background:#e5e7eb;
      color:#111827;
    }
    .btn-secondary:hover{
      background:#d1d5db;
    }
    table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 8px 24px rgba(15,23,42,.06);
    }
    thead th{
      background:var(--prim);
      color:#fff;
      font-weight:500;
      font-size:13px;
      padding:10px 8px;
      text-align:left;
      white-space:nowrap;
    }
    tbody td{
      border-top:1px solid var(--line);
      padding:8px 8px;
      font-size:13px;
      vertical-align:middle;
    }
    tbody tr:nth-child(even){ background:#f9fafb; }
    tbody tr:hover{ background:#eef2ff; }
    .col-data{ width:90px; }
    .col-obra{ width:220px; }
    .col-resp{ width:160px; }
    .col-num{ width:80px; text-align:center; }
    .col-acoes{ width:140px; text-align:center; }
    .text-center{ text-align:center; }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      background:#eef2ff;
      color:#374151;
    }
    .empty{
      text-align:center;
      padding:18px 8px;
      font-size:14px;
      color:var(--muted);
    }
    .link{
      color:var(--prim);
      text-decoration:none;
      font-size:13px;
    }
    .link:hover{ text-decoration:underline; }
  </style>
</head>
<body>
<header>
  <div>
    <h1>Curadoria do Diário de Obra</h1>
    <p>Filtre, visualize, edite e abra os detalhes de cada diário</p>
  </div>
  <div class="user-box">
    <span>Olá, <strong id="currentUserName">carregando...</strong></span>
    <button class="btn" id="btnLogout">Sair</button>
  </div>
</header>

<main>
  <section class="filters">
    <div class="filters-grid">
      <div>
        <label for="fObra">Obra</label>
        <input id="fObra" type="text" placeholder="Nome da obra" />
      </div>
      <div>
        <label for="fResp">Responsável</label>
        <input id="fResp" type="text" placeholder="Quem preencheu" />
      </div>
      <div>
        <label for="fDataDe">Data inicial</label>
        <input id="fDataDe" type="date" />
      </div>
      <div>
        <label for="fDataAte">Data final</label>
        <input id="fDataAte" type="date" />
      </div>
      <div>
        <label for="fCodInter">Cód. intercorrência</label>
        <input id="fCodInter" type="text" placeholder="Ex: 15" />
      </div>
      <div>
        <label for="fTexto">Busca livre (obs/descrições)</label>
        <input id="fTexto" type="text" placeholder="Palavra-chave" />
      </div>
    </div>
    <div class="filters-actions">
      <button class="btn btn-secondary" id="btnLimpar">Limpar</button>
      <button class="btn" id="btnBuscar">Buscar</button>
    </div>
  </section>

  <section>
    <table>
      <thead>
        <tr>
          <th class="col-data">Data</th>
          <th class="col-obra">Obra</th>
          <th class="col-resp">Responsável</th>
          <th class="col-num text-center">Presentes</th>
          <th class="col-num text-center">Ausentes</th>
          <th class="col-num text-center">Férias</th>
          <th class="col-acoes text-center">Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyDiarios">
        <tr><td colspan="7" class="empty">Carregando...</td></tr>
      </tbody>
    </table>
  </section>
</main>

<script>
  // Helper: formata data YYYY-MM-DD -> dd/mm/aaaa
  function formatDate(iso){
    if(!iso) return '';
    const [y,m,d] = iso.split('-');
    if(!y || !m || !d) return iso;
    return `${d}/${m}/${y}`;
  }

  async function carregarUsuario(){
    try{
      const resp = await fetch('/api/me', { credentials:'include' });
      if(!resp.ok){
        // não logado -> volta pro login
        window.location.href = 'login.html';
        return;
      }
      const data = await resp.json();
      if(!data.user){
        window.location.href = 'login.html';
        return;
      }
      const email = data.user.email || '';
      let nomeCurto = 'usuário';
      if(email.includes('@')){
        nomeCurto = email.split('@')[0] || 'usuário';
      }else if(data.user.nome){
        nomeCurto = data.user.nome;
      }
      document.getElementById('currentUserName').textContent = nomeCurto;
    }catch(err){
      console.error('Erro ao carregar usuário:', err);
      window.location.href = 'login.html';
    }
  }

  async function carregarDiarios(){
    const tbody = document.getElementById('tbodyDiarios');
    tbody.innerHTML = '<tr><td colspan="7" class="empty">Carregando...</td></tr>';

    const params = new URLSearchParams();
    const obra = document.getElementById('fObra').value.trim();
    const resp = document.getElementById('fResp').value.trim();
    const dataDe = document.getElementById('fDataDe').value;
    const dataAte = document.getElementById('fDataAte').value;
    const codInter = document.getElementById('fCodInter').value.trim();
    const texto = document.getElementById('fTexto').value.trim();

    if(obra) params.append('obra', obra);
    if(resp) params.append('responsavel', resp);
    if(dataDe) params.append('dataDe', dataDe);
    if(dataAte) params.append('dataAte', dataAte);
    if(codInter) params.append('codInter', codInter);
    if(texto) params.append('texto', texto);

    try{
      const url = '/api/diarios?' + params.toString();
      const r = await fetch(url, { credentials:'include' });
      if(r.status === 401){
        window.location.href = 'login.html';
        return;
      }
      if(!r.ok){
        console.error('Erro ao buscar diários', r.status);
        tbody.innerHTML = '<tr><td colspan="7" class="empty">Erro ao carregar diários.</td></tr>';
        return;
      }
      const lista = await r.json();
      if(!Array.isArray(lista) || lista.length === 0){
        tbody.innerHTML = '<tr><td colspan="7" class="empty">Nenhum diário encontrado.</td></tr>';
        return;
      }
      tbody.innerHTML = '';
      for(const d of lista){
        const tr = document.createElement('tr');

        const tdData = document.createElement('td');
        tdData.className = 'col-data';
        tdData.textContent = formatDate(d.data);
        tr.appendChild(tdData);

        const tdObra = document.createElement('td');
        tdObra.className = 'col-obra';
        tdObra.textContent = d.obra || '-';
        tr.appendChild(tdObra);

        const tdResp = document.createElement('td');
        tdResp.className = 'col-resp';
        tdResp.textContent = d.responsavel || '-';
        tr.appendChild(tdResp);

        const tdPre = document.createElement('td');
        tdPre.className = 'col-num text-center';
        tdPre.innerHTML = `<span class="badge">${d.totalPresentes ?? 0}</span>`;
        tr.appendChild(tdPre);

        const tdAus = document.createElement('td');
        tdAus.className = 'col-num text-center';
        tdAus.innerHTML = `<span class="badge">${d.totalAusentes ?? 0}</span>`;
        tr.appendChild(tdAus);

        const tdFer = document.createElement('td');
        tdFer.className = 'col-num text-center';
        tdFer.innerHTML = `<span class="badge">${d.totalFerias ?? 0}</span>`;
        tr.appendChild(tdFer);

        const tdAcoes = document.createElement('td');
        tdAcoes.className = 'col-acoes text-center';
        const link = document.createElement('a');
        link.href = `details.html?id=${encodeURIComponent(d.id)}`;
        link.className = 'link';
        link.textContent = 'Ver detalhes';
        tdAcoes.appendChild(link);
        tr.appendChild(tdAcoes);

        tbody.appendChild(tr);
      }
    }catch(err){
      console.error(err);
      tbody.innerHTML = '<tr><td colspan="7" class="empty">Erro ao carregar diários.</td></tr>';
    }
  }

  function limparFiltros(){
    document.getElementById('fObra').value = '';
    document.getElementById('fResp').value = '';
    document.getElementById('fDataDe').value = '';
    document.getElementById('fDataAte').value = '';
    document.getElementById('fCodInter').value = '';
    document.getElementById('fTexto').value = '';
  }

  async function logout(){
    try{
      await fetch('/api/logout', { method:'POST', credentials:'include' });
    }catch(e){
      console.error(e);
    }
    window.location.href = 'login.html';
  }

  // Inicialização
  window.addEventListener('DOMContentLoaded', () => {
    carregarUsuario();
    carregarDiarios();

    document.getElementById('btnBuscar').addEventListener('click', carregarDiarios);
    document.getElementById('btnLimpar').addEventListener('click', () => {
      limparFiltros();
      carregarDiarios();
    });
    document.getElementById('btnLogout').addEventListener('click', logout);
  });
</script>
</body>
</html>
