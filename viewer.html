<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Curadoria do Diário de Obra</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#f4f6fb;
      --card:#ffffff;
      --prim:#3A6385;
      --prim-dark:#284666;
      --muted:#7b8794;
      --border:#e2e8f0;
      --danger:#e53e3e;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:var(--bg);
      color:#1f2933;
    }
    header{
      background:#fff;
      border-bottom:1px solid var(--border);
      padding:16px 24px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      position:sticky;
      top:0;
      z-index:10;
    }
    header h1{
      margin:0;
      font-size:20px;
      font-weight:600;
      color:#102a43;
    }
    header small{
      display:block;
      font-size:12px;
      color:var(--muted);
    }
    .user-area{
      display:flex;
      align-items:center;
      gap:12px;
      font-size:14px;
      color:var(--muted);
    }
    .btn{
      padding:8px 14px;
      border-radius:6px;
      border:none;
      cursor:pointer;
      font-size:14px;
      background:var(--prim);
      color:#fff;
    }
    .btn:hover{background:var(--prim-dark);}
    .btn-outline{
      background:#fff;
      color:var(--prim);
      border:1px solid var(--prim);
    }
    .btn-outline:hover{
      background:var(--prim);
      color:#fff;
    }
    main{
      max-width:1100px;
      margin:24px auto 40px;
      padding:0 16px;
    }
    .card{
      background:var(--card);
      border-radius:10px;
      box-shadow:0 8px 24px rgba(15,23,42,.06);
      padding:16px 18px 20px;
      margin-bottom:18px;
    }
    .filters{
      display:grid;
      grid-template-columns:repeat(6, minmax(0, 1fr));
      gap:10px;
      align-items:end;
    }
    label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:2px;
      display:block;
    }
    input, select{
      width:100%;
      padding:7px 8px;
      border-radius:6px;
      border:1px solid var(--border);
      font-size:13px;
      outline:none;
    }
    input:focus, select:focus{
      border-color:var(--prim);
      box-shadow:0 0 0 2px rgba(58,99,133,.16);
    }
    .filters-buttons{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      margin-top:10px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    thead th{
      background:var(--prim);
      color:#fff;
      padding:10px 8px;
      text-align:left;
      position:sticky;
      top:72px;
      z-index:5;
    }
    tbody td{
      border-bottom:1px solid var(--border);
      padding:8px 8px;
    }
    tbody tr:nth-child(even){
      background:#f8fafc;
    }
    tbody tr:hover{
      background:#edf2f7;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:26px;
      padding:2px 8px;
      border-radius:999px;
      background:#edf2ff;
      color:var(--prim);
      font-size:12px;
      font-weight:600;
    }
    .empty{
      text-align:center;
      padding:16px;
      color:var(--muted);
      font-size:14px;
    }
    .link{
      border:none;
      background:none;
      color:var(--prim);
      cursor:pointer;
      font-size:13px;
      padding:0;
      text-decoration:underline;
    }
    .error{
      margin-top:10px;
      font-size:13px;
      color:var(--danger);
    }
    @media (max-width:900px){
      .filters{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
      thead th{top:96px;}
    }
    @media (max-width:600px){
      .filters{
        grid-template-columns:1fr;
      }
      header{
        flex-direction:column;
        align-items:flex-start;
        gap:6px;
      }
      thead th{top:126px;}
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1>Curadoria do Diário de Obra</h1>
    <small>Filtre, visualize, edite e abra os detalhes de cada diário</small>
  </div>
  <div class="user-area">
    <span id="userGreeting">Olá, …</span>
    <button id="btnLogout" class="btn btn-outline">Sair</button>
  </div>
</header>

<main>
  <!-- FILTROS -->
  <section class="card">
    <div class="filters">
      <div>
        <label for="fObra">Obra</label>
        <input type="text" id="fObra" placeholder="Nome da obra" />
      </div>
      <div>
        <label for="fResp">Responsável</label>
        <input type="text" id="fResp" placeholder="Responsável" />
      </div>
      <div>
        <label for="fDataDe">Data inicial</label>
        <input type="date" id="fDataDe" />
      </div>
      <div>
        <label for="fDataAte">Data final</label>
        <input type="date" id="fDataAte" />
      </div>
      <div>
        <label for="fCodigoInter">Cód. intercorrência</label>
        <input type="text" id="fCodigoInter" placeholder="Ex.: 15" />
      </div>
      <div>
        <label for="fBuscaLivre">Busca livre (obs/descrições)</label>
        <input type="text" id="fBuscaLivre" placeholder="Qualquer texto…" />
      </div>
    </div>
    <div class="filters-buttons">
      <button id="btnLimpar" class="btn btn-outline">Limpar</button>
      <button id="btnBuscar" class="btn">Buscar</button>
    </div>
    <div id="errorBox" class="error" style="display:none;"></div>
  </section>

  <!-- LISTA -->
  <section class="card">
    <table>
      <thead>
        <tr>
          <th style="width:90px;">Data</th>
          <th>Obra</th>
          <th style="width:160px;">Responsável</th>
          <th style="width:90px;">Presentes</th>
          <th style="width:90px;">Ausentes</th>
          <th style="width:90px;">Férias</th>
          <th style="width:110px;">Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyDiarios">
      </tbody>
    </table>
    <div id="emptyState" class="empty" style="display:none;">
      Nenhum diário encontrado.
    </div>
  </section>
</main>

<script>
  // --------- UTIL ---------
  function formatarDataIsoParaBr(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return '';
    const dia = String(d.getDate()).padStart(2, '0');
    const mes = String(d.getMonth() + 1).padStart(2, '0');
    const ano = d.getFullYear();
    return `${dia}/${mes}/${ano}`;
  }

  // Calcula total de presentes / ausentes / férias a partir do diário
  function calcularTotais(diario) {
    // Se o back-end já mandar agregados, usamos
    if (typeof diario.presentes === 'number' ||
        typeof diario.ausentes === 'number' ||
        typeof diario.ferias === 'number') {

      const presentes = Number(diario.presentes || 0);
      const ausentes  = Number(diario.ausentes  || 0);
      const ferias    = Number(diario.ferias    || 0);
      return {
        presentes,
        ausentes,
        ferias,
        total: presentes + ausentes + ferias
      };
    }

    // Caso contrário, somamos a partir do array de funções
    let presentes = 0, ausentes = 0, ferias = 0;
    if (Array.isArray(diario.funcoes)) {
      diario.funcoes.forEach(f => {
        presentes += Number(f.presente || 0);
        ausentes  += Number(f.ausente  || 0);
        ferias    += Number(f.ferias   || 0);
      });
    }

    return {
      presentes,
      ausentes,
      ferias,
      total: presentes + ausentes + ferias
    };
  }

  // --------- AUTENTICAÇÃO / HEADER ---------
  async function carregarUsuario() {
    try {
      const resp = await fetch('/api/me', { credentials:'include' });
      if (!resp.ok) {
        // não autenticado
        window.location.href = 'login.html';
        return;
      }
      const data = await resp.json();
      const user = data && data.user;
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      const email = user.email || '';
      const nomeCurto = email.split('@')[0] || email || 'usuário';
      document.getElementById('userGreeting').textContent = `Olá, ${nomeCurto}`;
    } catch (e) {
      console.error(e);
      // em último caso, volta pro login
      window.location.href = 'login.html';
    }
  }

  async function logout() {
    try {
      await fetch('/api/logout', { method:'POST', credentials:'include' });
    } catch (e) {
      console.error(e);
    } finally {
      window.location.href = 'login.html';
    }
  }

  // --------- CARREGAR DIÁRIOS ---------
  async function carregarDiarios() {
    const tbody = document.getElementById('tbodyDiarios');
    const empty = document.getElementById('emptyState');
    const errorBox = document.getElementById('errorBox');
    tbody.innerHTML = '';
    empty.style.display = 'none';
    errorBox.style.display = 'none';

    const params = new URLSearchParams();

    const obra = document.getElementById('fObra').value.trim();
    const resp = document.getElementById('fResp').value.trim();
    const dDe  = document.getElementById('fDataDe').value;
    const dAte = document.getElementById('fDataAte').value;
    const cod  = document.getElementById('fCodigoInter').value.trim();
    const txt  = document.getElementById('fBuscaLivre').value.trim();

    if (obra) params.set('obra', obra);
    if (resp) params.set('responsavel', resp);
    if (dDe)  params.set('dataDe', dDe);
    if (dAte) params.set('dataAte', dAte);
    if (cod)  params.set('codigoInter', cod);
    if (txt)  params.set('q', txt);

    try {
      const respFetch = await fetch('/api/diarios?' + params.toString(), {
        credentials:'include'
      });

      if (respFetch.status === 401) {
        // sessão expirada
        window.location.href = 'login.html';
        return;
      }

      if (!respFetch.ok) {
        const t = await respFetch.text();
        throw new Error(t || 'Erro ao buscar diários');
      }

      const diarios = await respFetch.json();
      if (!Array.isArray(diarios) || diarios.length === 0) {
        empty.style.display = 'block';
        return;
      }

      diarios.forEach(diario => {
        const tr = document.createElement('tr');

        const totais = calcularTotais(diario);

        const dataBr = diario.dataBr || formatarDataIsoParaBr(diario.data);

        tr.innerHTML = `
          <td>${dataBr || ''}</td>
          <td>${diario.obra || ''}</td>
          <td>${diario.responsavel || ''}</td>
          <td><span class="badge">${totais.presentes}</span></td>
          <td><span class="badge">${totais.ausentes}</span></td>
          <td><span class="badge">${totais.ferias}</span></td>
          <td>
            <button class="link" data-id="${diario.id}">Ver detalhes</button>
          </td>
        `;

        tbody.appendChild(tr);
      });

      // click em "Ver detalhes"
      tbody.querySelectorAll('button.link').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          if (id) {
            window.location.href = `details.html?id=${encodeURIComponent(id)}`;
          }
        });
      });

    } catch (err) {
      console.error(err);
      errorBox.textContent = 'Erro ao carregar diários. Tente novamente.';
      errorBox.style.display = 'block';
    }
  }

  function limparFiltros() {
    document.getElementById('fObra').value = '';
    document.getElementById('fResp').value = '';
    document.getElementById('fDataDe').value = '';
    document.getElementById('fDataAte').value = '';
    document.getElementById('fCodigoInter').value = '';
    document.getElementById('fBuscaLivre').value = '';
    carregarDiarios();
  }

  // --------- INIT ---------
  window.addEventListener('DOMContentLoaded', () => {
    carregarUsuario();
    carregarDiarios();

    document.getElementById('btnBuscar')
      .addEventListener('click', carregarDiarios);

    document.getElementById('btnLimpar')
      .addEventListener('click', limparFiltros);

    document.getElementById('btnLogout')
      .addEventListener('click', logout);
  });
</script>
</body>
</html>
